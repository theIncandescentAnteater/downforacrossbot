name: Docker Build and Push

on:
  push:
    branches:
      - main
    tags:
      - "v*"
    paths-ignore:
      - "**.md"
      - ".github/workflows/**"
      - ".dockerignore"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write
  security-events: write

jobs:
  build-and-push:
    uses: ./.github/workflows/docker-build.yml
    with:
      tags: |
        type=ref,event=branch
        type=semver,pattern={{version}}
        type=semver,pattern={{major}}.{{minor}}
        type=semver,pattern={{major}}
        type=sha
        type=raw,value=latest,enable={{is_default_branch}}
      test-image-tag: latest
      platforms: linux/amd64,linux/arm64
